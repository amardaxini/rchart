<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module Scale - rchart 2.0.4</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/scale.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-clear_scale">#clear_scale</a>
    
    <li><a href="#method-i-draw_right_scale">#draw_right_scale</a>
    
    <li><a href="#method-i-draw_scale">#draw_scale</a>
    
    <li><a href="#method-i-draw_xy_scale">#draw_xy_scale</a>
    
    <li><a href="#method-i-set_fixed_scale">#set_fixed_scale</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./BarChart.html">BarChart</a>
  
    <li><a href="./ColorPalette.html">ColorPalette</a>
  
    <li><a href="./CubicChart.html">CubicChart</a>
  
    <li><a href="./GD2.html">GD2</a>
  
    <li><a href="./Graph.html">Graph</a>
  
    <li><a href="./GraphHelper.html">GraphHelper</a>
  
    <li><a href="./Layout.html">Layout</a>
  
    <li><a href="./Legend.html">Legend</a>
  
    <li><a href="./LineChart.html">LineChart</a>
  
    <li><a href="./PieChart.html">PieChart</a>
  
    <li><a href="./PlotChart.html">PlotChart</a>
  
    <li><a href="./Rchart.html">Rchart</a>
  
    <li><a href="./RchartHelper.html">RchartHelper</a>
  
    <li><a href="./Rdata.html">Rdata</a>
  
    <li><a href="./Scale.html">Scale</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module Scale</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-clear_scale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_scale</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Allow you to clear the scale : used if drawing multiple charts You’ll need
to call this function only if you’re planning to draw a second chart in the
rendered picture. Calling this function will clear the current scaling
parameters thus you’ll need to call again the <a
href="Scale.html#method-i-draw_scale">#draw_scale</a> function before
drawing any new chart.</p>
          

          
          <div class="method-source-code" id="clear_scale-source">
            <pre><span class="ruby-comment"># File lib/scale.rb, line 5</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clear_scale</span>
  <span class="ruby-ivar">@vmin</span>     = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@vmax</span>       = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@v_x_min</span>   = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@v_x_max</span>      = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@divisions</span>  = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@x_divisions</span> = <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clear_scale-source -->
          
        </div>

        

        
      </div><!-- clear_scale-method -->

    
      <div id="method-i-draw_right_scale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_right_scale</span><span
            class="method-args">(data,data_description,scale_mode,r,g,b,draw_ticks=true,angle=0,decimals=1,with_margin=false,skip_labels=1)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Wrapper to the <a href="Scale.html#method-i-draw_scale">#draw_scale</a>
function allowing a second scale to be drawn It takes the same parameters
of the <a href="Scale.html#method-i-draw_scale">#draw_scale</a> function.
The scale values will be written on the right side of the graph area.</p>
          

          
          <div class="method-source-code" id="draw_right_scale-source">
            <pre><span class="ruby-comment"># File lib/scale.rb, line 32</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">draw_right_scale</span>(<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_description</span>,<span class="ruby-identifier">scale_mode</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>,<span class="ruby-identifier">draw_ticks</span>=<span class="ruby-keyword">true</span>,<span class="ruby-identifier">angle</span>=<span class="ruby-value">0</span>,<span class="ruby-identifier">decimals</span>=<span class="ruby-value">1</span>,<span class="ruby-identifier">with_margin</span>=<span class="ruby-keyword">false</span>,<span class="ruby-identifier">skip_labels</span>=<span class="ruby-value">1</span>)
  <span class="ruby-keyword">self</span>.       <span class="ruby-identifier">draw_scale</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">data_description</span>, <span class="ruby-identifier">scale_mode</span>, <span class="ruby-identifier">r</span>, <span class="ruby-identifier">g</span>, <span class="ruby-identifier">b</span>,<span class="ruby-identifier">draw_ticks</span>,<span class="ruby-identifier">angle</span>,<span class="ruby-identifier">decimals</span>,<span class="ruby-identifier">with_margin</span>,<span class="ruby-identifier">skip_labels</span>,<span class="ruby-keyword">true</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- draw_right_scale-source -->
          
        </div>

        

        
      </div><!-- draw_right_scale-method -->

    
      <div id="method-i-draw_scale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_scale</span><span
            class="method-args">(data,data_description,scale_mode,r,g,b,draw_ticks=true,angle=0,decimals=1,with_margin=false,skip_labels=1,right_scale=false)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This function will draw both axis and write values on it. You can disable
the labelling of the axis setting draw_ticks to false. angle can be used to
rotate the vertical ticks labels. decimal specify the number of decimal
values we want to keep. Setting draw_ticks to false will not draw vertical
&amp; horizontal ticks on the axis ( labels will also not be written ).
There is four way of computing scales :</p>
<ul><li>
<p>Getting Max &amp; Min values per serie : scale_mode = Rchart::SCALE_NORMAL</p>
</li><li>
<p>Like the previous one but setting the min value to 0 : scale_mode =
Rchart::SCALE_START0</p>
</li><li>
<p>Getting the series cumulative Max &amp; Min values : scale_mode =
Rchart::SCALE_ADDALL</p>
</li><li>
<p>Like the previous one but setting the min value to 0 : scale_mode =
Rchart::SCALE_ADDALLSTART0</p>
</li></ul>

<p>This will depends on the kind of graph you are drawing,   Drawing graphs
were you want to fix the min value to 0 you must use the
Rchart::SCALE_START0 option. You can display only one x label every xi
labels using the skip_labels parameter. Keeping with_margin to false will
make the chart use all the width of the graph area. For most graphs the
rendering will be better. In some circumstances you’ll have to set it to
true ( introducing left &amp; right margin ) : bar charts will require it.</p>
          

          
          <div class="method-source-code" id="draw_scale-source">
            <pre><span class="ruby-comment"># File lib/scale.rb, line 46</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">draw_scale</span>(<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_description</span>,<span class="ruby-identifier">scale_mode</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>,<span class="ruby-identifier">draw_ticks</span>=<span class="ruby-keyword">true</span>,<span class="ruby-identifier">angle</span>=<span class="ruby-value">0</span>,<span class="ruby-identifier">decimals</span>=<span class="ruby-value">1</span>,<span class="ruby-identifier">with_margin</span>=<span class="ruby-keyword">false</span>,<span class="ruby-identifier">skip_labels</span>=<span class="ruby-value">1</span>,<span class="ruby-identifier">right_scale</span>=<span class="ruby-keyword">false</span>)
    <span class="ruby-comment"># Validate the Data and DataDescription array</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">validate_data</span>(<span class="ruby-string">&quot;draw_scale&quot;</span>,<span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">c_text_color</span>         = <span class="ruby-identifier">allocate_color</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-ivar">@g_area_y1</span>,<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-ivar">@g_area_x2</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
    <span class="ruby-identifier">scale</span> =<span class="ruby-value">0</span>
    <span class="ruby-identifier">divisions</span> =<span class="ruby-value">0</span>
    <span class="ruby-keyword">if</span>(<span class="ruby-ivar">@vmin</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">nil?</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">nil?</span>)
        <span class="ruby-comment">#My hack TODO for LINE GRAPH</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
          <span class="ruby-ivar">@vmin</span> =<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>][<span class="ruby-value">0</span>]]
          <span class="ruby-ivar">@vmax</span> =<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>][<span class="ruby-value">0</span>]]
        <span class="ruby-keyword">else</span>
          <span class="ruby-ivar">@vmin</span> =<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>][<span class="ruby-value">0</span>]]
          <span class="ruby-ivar">@vmax</span> =<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>]]
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">else</span>
        <span class="ruby-ivar">@vmin</span> = <span class="ruby-value">2147483647</span>
        <span class="ruby-ivar">@vmax</span> = <span class="ruby-value">-2147483647</span>
      <span class="ruby-keyword">end</span>
<span class="ruby-comment">#       /* Compute Min and Max values */</span>
      <span class="ruby-keyword">if</span>(<span class="ruby-identifier">scale_mode</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Rchart</span><span class="ruby-operator">::</span><span class="ruby-constant">SCALE_NORMAL</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">scale_mode</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Rchart</span><span class="ruby-operator">::</span><span class="ruby-constant">SCALE_START0</span>)
        <span class="ruby-ivar">@vmin</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">scale_mode</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Rchart</span><span class="ruby-operator">::</span><span class="ruby-constant">SCALE_START0</span> )

        <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">col_name</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">if</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">key</span>[<span class="ruby-identifier">col_name</span>].<span class="ruby-identifier">nil?</span>)
              <span class="ruby-identifier">value</span> = <span class="ruby-identifier">key</span>[<span class="ruby-identifier">col_name</span>]
              <span class="ruby-keyword">if</span> (<span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>))
                <span class="ruby-ivar">@vmax</span> = <span class="ruby-identifier">value</span> <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">value</span>)
                <span class="ruby-ivar">@vmin</span> = <span class="ruby-identifier">value</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@vmin</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">value</span>)
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">scale_mode</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Rchart</span><span class="ruby-operator">::</span><span class="ruby-constant">SCALE_ADDALL</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">scale_mode</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Rchart</span><span class="ruby-operator">::</span><span class="ruby-constant">SCALE_ADDALLSTART0</span> ) <span class="ruby-comment"># Experimental</span>
        <span class="ruby-ivar">@vmin</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">scale_mode</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Rchart</span><span class="ruby-operator">::</span><span class="ruby-constant">SCALE_ADDALLSTART0</span>)
        <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">sum</span> = <span class="ruby-value">0</span>
          <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;values&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span><span class="ruby-operator">|</span><span class="ruby-identifier">col_name</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">key</span>[<span class="ruby-identifier">col_name</span>].<span class="ruby-identifier">nil?</span>)
              <span class="ruby-identifier">value</span> =<span class="ruby-identifier">key</span>[<span class="ruby-identifier">col_name</span>]
              <span class="ruby-identifier">sum</span>  <span class="ruby-operator">+=</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword">if</span> ((<span class="ruby-identifier">value</span>).<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>))
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-ivar">@vmax</span> = <span class="ruby-identifier">sum</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@vmax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">sum</span>)
          <span class="ruby-ivar">@vmin</span> = <span class="ruby-identifier">sum</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@vmin</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sum</span>)
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span>(<span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>))
        <span class="ruby-ivar">@vmax</span> = <span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\.[0-9]+/</span>,<span class="ruby-string">''</span>)<span class="ruby-operator">+</span><span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@vmax</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\.[0-9]+/</span>,<span class="ruby-string">''</span>) )
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># If all values are the same */</span>
      <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@vmin</span> )
        <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span> )
          <span class="ruby-ivar">@vmax</span> = <span class="ruby-ivar">@vmax</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-ivar">@vmin</span> = <span class="ruby-ivar">@vmin</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">data_range</span> = <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span>
      <span class="ruby-identifier">data_range</span> = <span class="ruby-value">0.1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">data_range</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span>)

      <span class="ruby-comment">#Compute automatic scaling */</span>
      <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-identifier">factor</span> = <span class="ruby-value">1</span>
      <span class="ruby-identifier">min_div_height</span> = <span class="ruby-value">25</span>
      <span class="ruby-identifier">max_divs</span> = (<span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span>)*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">min_div_height</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@vmin</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
        <span class="ruby-ivar">@vmin</span> = <span class="ruby-value">0</span>
        <span class="ruby-ivar">@vmax</span> = <span class="ruby-value">2</span>
        <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
        <span class="ruby-identifier">divisions</span> = <span class="ruby-value">2</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>)
        <span class="ruby-keyword">while</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">scale1</span> = ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>
          <span class="ruby-identifier">scale2</span> = ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span><span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
      <span class="ruby-comment">#    scale4 = ( @vmax - @vmin )*1.0 / factor / 4</span>
          <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale1</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">scale1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
            <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">true</span>
            <span class="ruby-identifier">divisions</span> = (<span class="ruby-identifier">scale1</span>).<span class="ruby-identifier">floor</span>
            <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">scale2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
            <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">true</span>
            <span class="ruby-identifier">divisions</span> = (<span class="ruby-identifier">scale2</span>).<span class="ruby-identifier">floor</span>
            <span class="ruby-identifier">scale</span> = <span class="ruby-value">2</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
            <span class="ruby-identifier">factor</span> = <span class="ruby-identifier">factor</span> * <span class="ruby-value">10</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
            <span class="ruby-identifier">factor</span> = <span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">10</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> )
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># while end</span>
        <span class="ruby-keyword">if</span> ((((<span class="ruby-ivar">@vmax</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>)).<span class="ruby-identifier">floor</span> <span class="ruby-operator">!=</span> ((<span class="ruby-ivar">@vmax</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>))
          <span class="ruby-identifier">grid_id</span>     = ( <span class="ruby-ivar">@vmax</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span>  <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
          <span class="ruby-ivar">@vmax</span>       = <span class="ruby-identifier">grid_id</span> * <span class="ruby-identifier">scale</span> * <span class="ruby-identifier">factor</span>
          <span class="ruby-identifier">divisions</span>   = <span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> (((<span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span> <span class="ruby-operator">!=</span> ((<span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>))

          <span class="ruby-identifier">grid_id</span>     = ( <span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span>
          <span class="ruby-ivar">@vmin</span>       = <span class="ruby-identifier">grid_id</span> * <span class="ruby-identifier">scale</span> * <span class="ruby-identifier">factor</span>*<span class="ruby-value">1.0</span>
          <span class="ruby-identifier">divisions</span>   = <span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">else</span> <span class="ruby-comment">#/* Can occurs for small graphs */</span>
        <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">divisions</span> = <span class="ruby-value">2</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">divisions</span>.<span class="ruby-identifier">nil?</span> )

      <span class="ruby-comment"># divisions = divisions-1 if (scale == 1 &amp;&amp; divisions%2 == 1)</span>

    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">divisions</span> = <span class="ruby-ivar">@divisions</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@division_count</span> = <span class="ruby-identifier">divisions</span>
    <span class="ruby-identifier">data_range</span> = <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span>
    <span class="ruby-identifier">data_range</span> = <span class="ruby-value">0.1</span>  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">data_range</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span> )
    <span class="ruby-ivar">@division_height</span> = ( <span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">divisions</span>
    <span class="ruby-ivar">@division_ratio</span>  = ( <span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span><span class="ruby-identifier">data_range</span>
    <span class="ruby-ivar">@g_area_x_offset</span>  = <span class="ruby-value">0</span>
    <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
      <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">with_margin</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>)
        <span class="ruby-ivar">@division_width</span> = ( <span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> ((<span class="ruby-identifier">data</span>).<span class="ruby-identifier">count</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-ivar">@division_width</span> = ( <span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span> ) *<span class="ruby-value">1.0</span><span class="ruby-operator">/</span> (<span class="ruby-identifier">data</span>).<span class="ruby-identifier">count</span>
        <span class="ruby-ivar">@g_area_x_offset</span>  = <span class="ruby-ivar">@division_width</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@division_width</span> = (<span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span>)*<span class="ruby-value">1.0</span>
      <span class="ruby-ivar">@g_area_x_offset</span>  = <span class="ruby-ivar">@division_width</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@data_count</span> = (<span class="ruby-identifier">data</span>).<span class="ruby-identifier">count</span>
    <span class="ruby-keyword">return</span>(<span class="ruby-value">0</span>) <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_ticks</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> )
    <span class="ruby-identifier">ypos</span> = <span class="ruby-ivar">@g_area_y2</span>
    <span class="ruby-identifier">xmin</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">i</span> =<span class="ruby-value">1</span>

    <span class="ruby-keyword">while</span>(<span class="ruby-identifier">i</span><span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">right_scale</span> )
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x2</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-ivar">@g_area_x2</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">value</span>     = <span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>) * (( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">divisions</span>)
      <span class="ruby-identifier">value</span>     = (<span class="ruby-identifier">round_of</span>(<span class="ruby-identifier">value</span> * (<span class="ruby-value">10</span><span class="ruby-operator">**</span><span class="ruby-identifier">decimals</span>),<span class="ruby-value">2</span>)) <span class="ruby-operator">/</span> (<span class="ruby-value">10</span><span class="ruby-operator">**</span><span class="ruby-identifier">decimals</span>)
      <span class="ruby-identifier">value</span>= <span class="ruby-identifier">value</span>.<span class="ruby-identifier">round</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">floor</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">ceil</span>
      <span class="ruby-identifier">value</span> = <span class="ruby-node">&quot;#{value} #{data_description['unit']['y']}&quot;</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>]<span class="ruby-operator">==</span> <span class="ruby-string">&quot;number&quot;</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_time</span>(<span class="ruby-identifier">value</span>)                  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;time&quot;</span> )
      <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_date</span>(<span class="ruby-identifier">value</span>)                  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;date&quot;</span> )
      <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_metric</span>(<span class="ruby-identifier">value</span>)                <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;Y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;metric&quot;</span> )
      <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_currency</span>(<span class="ruby-identifier">value</span>)             <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;Y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;currency&quot;</span> )
      <span class="ruby-identifier">position</span>  = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
      <span class="ruby-identifier">text_width</span> =<span class="ruby-identifier">position</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">position</span>[<span class="ruby-value">0</span>]
      <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">right_scale</span> )
        <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-ivar">@g_area_x2</span><span class="ruby-operator">+</span><span class="ruby-value">10</span>,<span class="ruby-identifier">ypos</span><span class="ruby-operator">+</span>(<span class="ruby-ivar">@font_size</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>),<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">xmin</span> = <span class="ruby-ivar">@g_area_x2</span><span class="ruby-operator">+</span><span class="ruby-value">15</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_width</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">xmin</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">xmin</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@g_area_x2</span><span class="ruby-operator">+</span><span class="ruby-value">15</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_width</span>  )
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">10</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span>,<span class="ruby-identifier">ypos</span><span class="ruby-operator">+</span>(<span class="ruby-ivar">@font_size</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>),<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">xmin</span> = <span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">10</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span> <span class="ruby-keyword">if</span> (  <span class="ruby-identifier">xmin</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">xmin</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">10</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">ypos</span> = <span class="ruby-identifier">ypos</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@division_height</span>
      <span class="ruby-identifier">i</span> = <span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># Write the Y Axis caption if set */</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>].<span class="ruby-identifier">nil?</span> )
      <span class="ruby-identifier">position</span>   = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>])
      <span class="ruby-identifier">text_height</span> = (<span class="ruby-identifier">position</span>[<span class="ruby-value">1</span>]).<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">position</span>[<span class="ruby-value">3</span>]).<span class="ruby-identifier">abs</span>
      <span class="ruby-identifier">text_top</span>    = ((<span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span>) <span class="ruby-operator">/</span> <span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@g_area_y1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">text_height</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>)

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">right_scale</span> )
        <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-identifier">xmin</span><span class="ruby-operator">+</span><span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">text_top</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-identifier">xmin</span><span class="ruby-operator">-</span><span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">text_top</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>])
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># Horizontal Axis */</span>
    <span class="ruby-identifier">xpos</span> = <span class="ruby-ivar">@g_area_x1</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@g_area_x_offset</span>
    <span class="ruby-identifier">id</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">ymax</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">id</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">skip_labels</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>((<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span>,<span class="ruby-ivar">@g_area_y2</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span>,<span class="ruby-ivar">@g_area_y2</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
        <span class="ruby-identifier">value</span>      =<span class="ruby-identifier">key</span>[<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;position&quot;</span>]]
        <span class="ruby-identifier">value</span> =  <span class="ruby-node">&quot;#{value} #{data_description['unit']['x']}&quot;</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;number&quot;</span> )
        <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_time</span>(<span class="ruby-identifier">value</span>)       <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;time&quot;</span> )
        <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_date</span>(<span class="ruby-identifier">value</span>)       <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;date&quot;</span> )
        <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_metric</span>(<span class="ruby-identifier">value</span>)     <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;metric&quot;</span> )
        <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_currency</span>(<span class="ruby-identifier">value</span>)   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;currency&quot;</span> )
        <span class="ruby-identifier">position</span>   = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>)
        <span class="ruby-identifier">text_width</span>  = (<span class="ruby-identifier">position</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">position</span>[<span class="ruby-value">0</span>]).<span class="ruby-identifier">abs</span>
        <span class="ruby-identifier">text_height</span> = (<span class="ruby-identifier">position</span>[<span class="ruby-value">1</span>]).<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">position</span>[<span class="ruby-value">3</span>]).<span class="ruby-identifier">abs</span>
        <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">angle</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
          <span class="ruby-identifier">ypos</span> = <span class="ruby-ivar">@g_area_y2</span><span class="ruby-operator">+</span><span class="ruby-value">18</span>
          <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">text_width</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">floor</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>)
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">ypos</span> = <span class="ruby-ivar">@g_area_y2</span><span class="ruby-operator">+</span><span class="ruby-value">10</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_height</span>
          <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">angle</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">90</span> )
            <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>)
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_width</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">ypos</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ymax</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">ymax</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ymax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ypos</span>))
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">xpos</span> = <span class="ruby-identifier">xpos</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@division_width</span>
      <span class="ruby-identifier">id</span> = <span class="ruby-identifier">id</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>   <span class="ruby-comment">#loop ended</span>
    <span class="ruby-comment">#Write the X Axis caption if set */</span>

    <span class="ruby-keyword">if</span> ((<span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>].<span class="ruby-identifier">nil?</span>) )
      <span class="ruby-identifier">position</span>   = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>])
      <span class="ruby-identifier">text_width</span>  = (<span class="ruby-identifier">position</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">position</span>[<span class="ruby-value">0</span>]).<span class="ruby-identifier">abs</span>
      <span class="ruby-identifier">text_left</span>   = ((<span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span>) <span class="ruby-operator">/</span> <span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@g_area_x1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">text_width</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>)
      <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">text_left</span>,<span class="ruby-identifier">ymax</span><span class="ruby-operator">+</span><span class="ruby-ivar">@font_size</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>].<span class="ruby-identifier">to_s</span>)
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span></pre>
          </div><!-- draw_scale-source -->
          
        </div>

        

        
      </div><!-- draw_scale-method -->

    
      <div id="method-i-draw_xy_scale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_xy_scale</span><span
            class="method-args">(data,data_description,y_serie_name,x_serie_name,r,g,b,with_margin=0,angle=0,decimals=1)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This function is used by scatter charts. It will compute everything needed
to draw the associated line and plot charts. You must specify the name of
the two series that will be used as X and Y data. By default this function
will compute the min &amp; max values of both series, anyway you can
override the automatic scaling by calling first the setFixedScale function.</p>
          

          
          <div class="method-source-code" id="draw_xy_scale-source">
            <pre><span class="ruby-comment"># File lib/scale.rb, line 279</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">draw_xy_scale</span>(<span class="ruby-identifier">data</span>,<span class="ruby-identifier">data_description</span>,<span class="ruby-identifier">y_serie_name</span>,<span class="ruby-identifier">x_serie_name</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>,<span class="ruby-identifier">with_margin</span>=<span class="ruby-value">0</span>,<span class="ruby-identifier">angle</span>=<span class="ruby-value">0</span>,<span class="ruby-identifier">decimals</span>=<span class="ruby-value">1</span>)

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">validate_data</span>(<span class="ruby-string">&quot;draw_xy_scale&quot;</span>,<span class="ruby-identifier">data</span>)
  <span class="ruby-identifier">c_text_color</span>         = <span class="ruby-identifier">allocate_color</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-ivar">@g_area_y1</span>,<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-ivar">@g_area_x2</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)

  <span class="ruby-comment"># Process Y scale */</span>
  <span class="ruby-keyword">if</span>(<span class="ruby-ivar">@vmin</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">nil?</span>)
    <span class="ruby-ivar">@vmin</span> = <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">y_serie_name</span>]
    <span class="ruby-ivar">@vmax</span> = <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">y_serie_name</span>]
    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">key</span>[<span class="ruby-identifier">y_serie_name</span>].<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">key</span>[<span class="ruby-identifier">y_serie_name</span>]
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>))
          <span class="ruby-ivar">@vmax</span> = <span class="ruby-identifier">value</span> <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">value</span>)
          <span class="ruby-ivar">@vmin</span> = <span class="ruby-identifier">value</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@vmin</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">value</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span>(<span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>))
      <span class="ruby-ivar">@vmax</span> = <span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\.[0-9]+/</span>,<span class="ruby-string">''</span>)<span class="ruby-operator">+</span><span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@vmax</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@vmax</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\.[0-9]+/</span>,<span class="ruby-string">''</span>) )
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">data_range</span> = <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span>
    <span class="ruby-identifier">data_range</span> = <span class="ruby-value">0.1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">data_range</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span> )

    <span class="ruby-comment">#Compute automatic scaling</span>
    <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">factor</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">min_div_height</span> = <span class="ruby-value">25</span>
    <span class="ruby-identifier">max_divs</span> = (<span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span>)*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">min_div_height</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@vmin</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
      <span class="ruby-ivar">@vmin</span> = <span class="ruby-value">0</span>
      <span class="ruby-ivar">@vmax</span> = <span class="ruby-value">2</span>
      <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
      <span class="ruby-identifier">divisions</span> = <span class="ruby-value">2</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>)
      <span class="ruby-keyword">while</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
        <span class="ruby-identifier">scale1</span> = ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>
        <span class="ruby-identifier">scale2</span> = ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span><span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
        <span class="ruby-identifier">scale4</span> = ( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">4</span>

        <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale1</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">scale1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">divisions</span> = (<span class="ruby-identifier">scale1</span>).<span class="ruby-identifier">floor</span>
          <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">divisions</span> = (<span class="ruby-identifier">scale2</span>).<span class="ruby-identifier">floor</span>
          <span class="ruby-identifier">scale</span> = <span class="ruby-value">2</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">factor</span> = <span class="ruby-identifier">factor</span> * <span class="ruby-value">10.0</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
          <span class="ruby-identifier">factor</span> = <span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">10.0</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> )
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> ((((<span class="ruby-ivar">@vmax</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>)).<span class="ruby-identifier">floor</span> <span class="ruby-operator">!=</span> ((<span class="ruby-ivar">@vmax</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>))
        <span class="ruby-identifier">grid_id</span>     = ( <span class="ruby-ivar">@vmax</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span>  <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
        <span class="ruby-ivar">@vmax</span>       = <span class="ruby-identifier">grid_id</span> * <span class="ruby-identifier">scale</span> * <span class="ruby-identifier">factor</span>
        <span class="ruby-identifier">divisions</span>   = <span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (((<span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span> <span class="ruby-operator">!=</span> ((<span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>))

        <span class="ruby-identifier">grid_id</span>     = ( <span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span>
        <span class="ruby-ivar">@vmin</span>       = <span class="ruby-identifier">grid_id</span> * <span class="ruby-identifier">scale</span> * <span class="ruby-identifier">factor</span>*<span class="ruby-value">1.0</span>
        <span class="ruby-identifier">divisions</span>   = <span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">else</span> <span class="ruby-comment">#/* Can occurs for small graphs */</span>
      <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">divisions</span> = <span class="ruby-value">2</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">divisions</span>.<span class="ruby-identifier">nil?</span> )

    <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">is_real_int</span>((<span class="ruby-ivar">@vmax</span><span class="ruby-operator">-</span><span class="ruby-ivar">@vmin</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">divisions</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>)))
      <span class="ruby-identifier">divisions</span><span class="ruby-operator">-=</span><span class="ruby-value">1</span>
    <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">is_real_int</span>((<span class="ruby-ivar">@vmax</span><span class="ruby-operator">-</span><span class="ruby-ivar">@vmin</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)))
      <span class="ruby-identifier">divisions</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">divisions</span> = <span class="ruby-ivar">@divisions</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@division_count</span> = <span class="ruby-identifier">divisions</span>

  <span class="ruby-identifier">data_range</span> = <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span>
  <span class="ruby-identifier">data_range</span> = <span class="ruby-value">0.1</span>  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">data_range</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span> )
  <span class="ruby-ivar">@division_height</span> = ( <span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">divisions</span>
  <span class="ruby-ivar">@division_ratio</span>  = ( <span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span> )*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span><span class="ruby-identifier">data_range</span>
  <span class="ruby-identifier">ypos</span> = <span class="ruby-ivar">@g_area_y2</span>
  <span class="ruby-identifier">xmin</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">i</span> =<span class="ruby-value">1</span>

  <span class="ruby-keyword">while</span>(<span class="ruby-identifier">i</span><span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-ivar">@g_area_x1</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
    <span class="ruby-identifier">value</span>     = <span class="ruby-ivar">@vmin</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>) * (( <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">divisions</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">round</span>(<span class="ruby-identifier">decimals</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">round</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">floor</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">ceil</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-node">&quot;#{value} #{data_description['unit']['y']}&quot;</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>]<span class="ruby-operator">==</span> <span class="ruby-string">&quot;number&quot;</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_time</span>(<span class="ruby-identifier">value</span>)                  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;time&quot;</span> )
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_date</span>(<span class="ruby-identifier">value</span>)                  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;date&quot;</span> )
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_metric</span>(<span class="ruby-identifier">value</span>)                <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;Y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;metric&quot;</span> )
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_currency</span>(<span class="ruby-identifier">value</span>)             <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;Y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;currency&quot;</span> )

    <span class="ruby-identifier">position</span>  = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
    <span class="ruby-identifier">text_width</span> =<span class="ruby-identifier">position</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">position</span>[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">10</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span>,<span class="ruby-identifier">ypos</span><span class="ruby-operator">+</span>(<span class="ruby-ivar">@font_size</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>),<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
    <span class="ruby-identifier">xmin</span> = <span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">10</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span> <span class="ruby-keyword">if</span> (  <span class="ruby-identifier">xmin</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">xmin</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@g_area_x1</span><span class="ruby-operator">-</span><span class="ruby-value">10</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span>)
    <span class="ruby-identifier">ypos</span> = <span class="ruby-identifier">ypos</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@division_height</span>
    <span class="ruby-identifier">i</span> = <span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Process X scale */</span>
  <span class="ruby-keyword">if</span>(<span class="ruby-ivar">@v_x_min</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@v_x_max</span>.<span class="ruby-identifier">nil?</span>)

    <span class="ruby-ivar">@v_x_min</span> =<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">x_serie_name</span>]
    <span class="ruby-ivar">@v_x_max</span> =<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">x_serie_name</span>]
    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>

      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">key</span>[<span class="ruby-identifier">x_serie_name</span>].<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">key</span>[<span class="ruby-identifier">x_serie_name</span>]
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>))

          <span class="ruby-ivar">@v_x_max</span> = <span class="ruby-identifier">value</span> <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">value</span>)
          <span class="ruby-ivar">@v_x_min</span> = <span class="ruby-identifier">value</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@v_x_min</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">value</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@v_x_max</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>))
      <span class="ruby-ivar">@v_x_max</span> = <span class="ruby-ivar">@v_x_max</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\.[0-9]+/</span>,<span class="ruby-string">''</span>)<span class="ruby-operator">+</span><span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@v_x_max</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\.[0-9]+/</span>,<span class="ruby-string">''</span>) )
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">data_range</span> = <span class="ruby-ivar">@vmax</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@vmin</span>
    <span class="ruby-identifier">data_range</span> = <span class="ruby-value">0.1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">data_range</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span> )

    <span class="ruby-comment"># Compute automatic scaling</span>
    <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">factor</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">min_div_width</span> = <span class="ruby-value">25</span>
    <span class="ruby-identifier">max_divs</span> = (<span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">min_div_width</span>

    <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@v_x_min</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
      <span class="ruby-ivar">@v_x_min</span> = <span class="ruby-value">0</span>
      <span class="ruby-ivar">@v_x_max</span> = <span class="ruby-value">2</span>
      <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
      <span class="ruby-identifier">x_divisions</span> = <span class="ruby-value">2</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>)

      <span class="ruby-keyword">while</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
        <span class="ruby-identifier">scale1</span> = ( <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@v_x_min</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>
        <span class="ruby-identifier">scale2</span> = ( <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@v_x_min</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">2</span>
        <span class="ruby-identifier">scale4</span> = ( <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@v_x_min</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">4</span>
        <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale1</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">scale1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">x_divisions</span> = (<span class="ruby-identifier">scale1</span>).<span class="ruby-identifier">floor</span>
          <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_divs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">scale_ok</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">x_divisions</span> = (<span class="ruby-identifier">scale2</span>).<span class="ruby-identifier">floor</span>

          <span class="ruby-identifier">scale</span> = <span class="ruby-value">2</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">scale_ok</span>)
          <span class="ruby-identifier">factor</span> = <span class="ruby-identifier">factor</span> * <span class="ruby-value">10</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
          <span class="ruby-identifier">factor</span> = <span class="ruby-identifier">factor</span> <span class="ruby-operator">/</span> <span class="ruby-value">10</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">scale2</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> )
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> ( (<span class="ruby-ivar">@v_x_max</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>)
        <span class="ruby-identifier">grid_id</span>     =  ( <span class="ruby-ivar">@v_x_max</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
        <span class="ruby-ivar">@v_x_max</span> = <span class="ruby-identifier">grid_id</span> * <span class="ruby-identifier">scale</span> * <span class="ruby-identifier">factor</span>
        <span class="ruby-identifier">x_divisions</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> ( (<span class="ruby-ivar">@v_x_min</span>*<span class="ruby-value">1.0</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@v_x_min</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>)
        <span class="ruby-identifier">grid_id</span>     = ( <span class="ruby-ivar">@v_x_min</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">scale</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">factor</span>).<span class="ruby-identifier">floor</span>
        <span class="ruby-ivar">@v_x_min</span> = <span class="ruby-identifier">grid_id</span> * <span class="ruby-identifier">scale</span> * <span class="ruby-identifier">factor</span>
        <span class="ruby-identifier">x_divisions</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment">#/* Can occurs for small graphs */</span>
      <span class="ruby-identifier">scale</span> = <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">x_divisions</span> = <span class="ruby-value">2</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">x_divisions</span>.<span class="ruby-identifier">nil?</span> )

    <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">is_real_int</span>((<span class="ruby-ivar">@v_x_max</span><span class="ruby-operator">-</span><span class="ruby-ivar">@v_x_min</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">x_divisions</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>)))
      <span class="ruby-identifier">x_divisions</span><span class="ruby-operator">-=</span><span class="ruby-value">1</span>
    <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">is_real_int</span>((<span class="ruby-ivar">@v_x_max</span><span class="ruby-operator">-</span><span class="ruby-ivar">@v_x_min</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">x_divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)))
      <span class="ruby-identifier">x_divisions</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>

    <span class="ruby-identifier">x_divisions</span> = <span class="ruby-ivar">@x_divisions</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@x_division_count</span> = <span class="ruby-identifier">divisions</span>
  <span class="ruby-ivar">@data_count</span>      = <span class="ruby-identifier">divisions</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>

  <span class="ruby-identifier">x_data_range</span> = <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@v_x_min</span>
  <span class="ruby-identifier">x_data_range</span> = <span class="ruby-value">0.1</span>   <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">x_data_range</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )

  <span class="ruby-ivar">@division_width</span>   = ( <span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">x_divisions</span>
  <span class="ruby-ivar">@x_division_ratio</span>  = ( <span class="ruby-ivar">@g_area_x2</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span>.<span class="ruby-identifier">to_f</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">x_data_range</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-identifier">xpos</span> = <span class="ruby-ivar">@g_area_x1</span>
  <span class="ruby-identifier">ymax</span> =<span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">i</span>=<span class="ruby-value">1</span>

  <span class="ruby-keyword">while</span>(<span class="ruby-identifier">i</span><span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">x_divisions</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">draw_line</span>(<span class="ruby-identifier">xpos</span>,<span class="ruby-ivar">@g_area_y2</span>,<span class="ruby-identifier">xpos</span>,<span class="ruby-ivar">@g_area_y2</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-ivar">@v_x_min</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>) * (( <span class="ruby-ivar">@v_x_max</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@v_x_min</span> ) <span class="ruby-operator">/</span> <span class="ruby-identifier">x_divisions</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">round</span>(<span class="ruby-identifier">decimals</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">round</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">floor</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">ceil</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-node">&quot;#{value}#{data_description['unit']['y']}&quot;</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;number&quot;</span>)
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_time</span>(<span class="ruby-identifier">value</span>)                  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;time&quot;</span> )
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_date</span>(<span class="ruby-identifier">value</span>)                  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;date&quot;</span> )
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_metric</span>(<span class="ruby-identifier">value</span>)                <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;Y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;metric&quot;</span> )
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_currency</span>(<span class="ruby-identifier">value</span>)             <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;format&quot;</span>][<span class="ruby-string">&quot;Y&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;currency&quot;</span> )
    <span class="ruby-identifier">position</span>  = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
    <span class="ruby-identifier">text_width</span> =<span class="ruby-identifier">position</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span><span class="ruby-identifier">position</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">abs</span>
    <span class="ruby-identifier">text_height</span> = <span class="ruby-identifier">position</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span><span class="ruby-identifier">position</span>[<span class="ruby-value">3</span>].<span class="ruby-identifier">abs</span>

    <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">angle</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
      <span class="ruby-identifier">ypos</span> = <span class="ruby-ivar">@g_area_y2</span><span class="ruby-operator">+</span><span class="ruby-value">18</span>
      <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">text_width</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">floor</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
    <span class="ruby-keyword">else</span>

      <span class="ruby-identifier">ypos</span> = <span class="ruby-ivar">@g_area_y2</span><span class="ruby-operator">+</span><span class="ruby-value">10</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_height</span>
      <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">angle</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">90</span> )
        <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span><span class="ruby-operator">-</span><span class="ruby-identifier">text_width</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">angle</span>,(<span class="ruby-identifier">xpos</span>).<span class="ruby-identifier">floor</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_width</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">ypos</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">value</span>)
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">ypos</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ymax</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ymax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ypos</span>)
    <span class="ruby-identifier">i</span>=<span class="ruby-identifier">i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
    <span class="ruby-identifier">xpos</span> = <span class="ruby-identifier">xpos</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@division_width</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment">#Write the Y Axis caption if set</span>
  <span class="ruby-keyword">if</span> ((<span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>].<span class="ruby-identifier">nil?</span>) )
    <span class="ruby-identifier">position</span>   = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>])
    <span class="ruby-identifier">text_height</span>  = (<span class="ruby-identifier">position</span>[<span class="ruby-value">1</span>]).<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">position</span>[<span class="ruby-value">3</span>]).<span class="ruby-identifier">abs</span>
    <span class="ruby-identifier">text_top</span>   = ((<span class="ruby-ivar">@g_area_y2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_y1</span>) <span class="ruby-operator">/</span> <span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@g_area_y1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">text_width</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>)
    <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-identifier">xmin</span><span class="ruby-operator">-</span><span class="ruby-ivar">@font_size</span>,<span class="ruby-identifier">text_top</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;y&quot;</span>].<span class="ruby-identifier">to_s</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> ((<span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>].<span class="ruby-identifier">nil?</span>) )
    <span class="ruby-identifier">position</span>   = <span class="ruby-identifier">image_ftb_box</span>(<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">90</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>])
    <span class="ruby-identifier">text_width</span>  = (<span class="ruby-identifier">position</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">abs</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">position</span>[<span class="ruby-value">0</span>]).<span class="ruby-identifier">abs</span>
    <span class="ruby-identifier">text_left</span>   = ((<span class="ruby-ivar">@g_area_x2</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@g_area_x1</span>) <span class="ruby-operator">/</span> <span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-ivar">@g_area_x1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">text_width</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>)
    <span class="ruby-identifier">image_ttf_text</span>(<span class="ruby-ivar">@picture</span>,<span class="ruby-ivar">@font_size</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">text_left</span>,<span class="ruby-identifier">ymax</span><span class="ruby-operator">+</span><span class="ruby-ivar">@font_size</span><span class="ruby-operator">+</span><span class="ruby-value">5</span>,<span class="ruby-identifier">c_text_color</span>,<span class="ruby-ivar">@font_name</span>,<span class="ruby-identifier">data_description</span>[<span class="ruby-string">&quot;axis&quot;</span>][<span class="ruby-string">&quot;x&quot;</span>].<span class="ruby-identifier">to_s</span>)
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- draw_xy_scale-source -->
          
        </div>

        

        
      </div><!-- draw_xy_scale-method -->

    
      <div id="method-i-set_fixed_scale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_fixed_scale</span><span
            class="method-args">(v_min,v_max,divisions=5,v_x_min=nil,v_x_max=nil,x_divisions=5)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Allow you to fix the scale, use this to bypass the automatic scaling You
can use this function to skip the automatic scaling. vmin and vmax will be
used to render the graph.</p>
          

          
          <div class="method-source-code" id="set_fixed_scale-source">
            <pre><span class="ruby-comment"># File lib/scale.rb, line 17</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_fixed_scale</span>(<span class="ruby-identifier">v_min</span>,<span class="ruby-identifier">v_max</span>,<span class="ruby-identifier">divisions</span>=<span class="ruby-value">5</span>,<span class="ruby-identifier">v_x_min</span>=<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">v_x_max</span>=<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">x_divisions</span>=<span class="ruby-value">5</span>)
  <span class="ruby-ivar">@vmin</span>      = <span class="ruby-identifier">v_min</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-ivar">@vmax</span>      = <span class="ruby-identifier">v_max</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-ivar">@divisions</span> = <span class="ruby-identifier">divisions</span>.<span class="ruby-identifier">to_f</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">v_x_min</span>.<span class="ruby-identifier">nil?</span>)
    <span class="ruby-ivar">@v_x_min</span>      = <span class="ruby-identifier">v_x_min</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-ivar">@v_x_max</span>      = <span class="ruby-identifier">v_x_max</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-value">0.0</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">v_x_max</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-ivar">@x_divisions</span> = <span class="ruby-identifier">x_divisions</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_fixed_scale-source -->
          
        </div>

        

        
      </div><!-- set_fixed_scale-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

